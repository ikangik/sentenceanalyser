import React, { useState } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken } from 'firebase/auth';

// The following global variables are provided by the Canvas environment.
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Initialize Firebase App
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Sign in with custom token or anonymously
const signIn = async () => {
  try {
    if (initialAuthToken) {
      await signInWithCustomToken(auth, initialAuthToken);
    } else {
      await signInAnonymously(auth);
    }
  } catch (error) {
    console.error("Firebase sign-in failed:", error);
  }
};

const App = () => {
    const [sentence, setSentence] = useState('');
    const [analysis, setAnalysis] = useState(null);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleAnalyse = async () => {
        setIsLoading(true);
        setError('');
        setAnalysis(null);
        
        await signIn();

        // The prompt will instruct the model to analyse the sentence and provide a structured JSON response
        const prompt = `Analyse the following English sentence for grammar, spelling, and sentence structure and return a single JSON object. The grammatical and spelling rules for this analysis should be based on the standards of the Oxford English Dictionary (Australian spelling). Ensure that words like 'capitalisation' and 'capitalise' are used instead of their American English counterparts.
        
        The JSON object should have four top-level keys:
        1.  "posAnalysis": An array of objects. Each object should have two properties: "word" (the word itself) and "pos" (its part of speech, using the full word, not an acronym, e.g., "Noun", "Verb", "Adjective"). Please use "Exclamation" instead of "Interjection". For words like "hello", identify them as "Exclamation" unless the context clearly indicates a different function (e.g., "She gave a hello" where "hello" would be a Noun).
        2.  "grammarAnalysis": An object with the following properties:
            - "voice": A string indicating if the sentence is "Active" or "Passive".
            - "isCompleteSentence": a boolean indicating if it's a complete sentence.
            - "hasPunctuationErrors": a boolean indicating if there are punctuation issues.
            - "summary": A string providing a brief, one-sentence summary of any grammatical issues, including dependent clauses, syntax errors, and **incorrect use of capital letters**.
        3.  "spellingAnalysis": An array of objects. Each object should represent a misspelled word and contain:
            - "misspelledWord": The incorrect word found in the sentence.
            - "suggestions": An array of strings with potential correct spellings for that word.
        4.  "structuralAnalysis": An array of objects. Each object should represent a specific clause or phrase found in the sentence. Each object should contain:
            - "type": A string indicating the type of clause or phrase (e.g., "Independent Clause", "Noun Phrase", "Prepositional Phrase", "Participial Phrase", etc.).
            - "text": The exact text of the clause or phrase.
            - "function": A short string explaining what this clause or phrase does in the sentence.
        
        For multi-word verb phrases, like "was read", identify "was" as "Auxiliary Verb" and "read" as "Verb". "We organised" should correctly identify "we" as "Pronoun" and "organised" as "Verb".

        Sentence: "${sentence}"
        
        Example of desired output:
        {
          "posAnalysis": [
            { "word": "The", "pos": "Determiner" },
            { "word": "book", "pos": "Noun" },
            { "word": "was", "pos": "Auxiliary Verb" },
            { "word": "read", "pos": "Verb" },
            { "word": "by", "pos": "Preposition" },
            { "word": "the", "pos": "Determiner" },
            { "word": "student", "pos": "Noun" }
          ],
          "grammarAnalysis": {
            "voice": "Passive",
            "isCompleteSentence": true,
            "hasPunctuationErrors": false,
            "summary": "The sentence is grammatically correct and uses the passive voice."
          },
          "spellingAnalysis": [
            {
              "misspelledWord": "seantence",
              "suggestions": ["sentence", "sentience"]
            }
          ],
          "structuralAnalysis": [
            { "type": "Independent Clause", "text": "The book was read by the student.", "function": "This is the main part of the sentence and can stand alone." },
            { "type": "Noun Phrase", "text": "The book", "function": "Acts as the subject of the sentence." },
            { "type": "Prepositional Phrase", "text": "by the student", "function": "Modifies the verb 'was read' by indicating the doer of the action." }
          ]
        }`;

        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        "posAnalysis": {
                            "type": "ARRAY",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "word": { "type": "STRING" },
                                    "pos": { "type": "STRING" }
                                },
                                "propertyOrdering": ["word", "pos"]
                            }
                        },
                        "grammarAnalysis": {
                            "type": "OBJECT",
                            "properties": {
                                "voice": { "type": "STRING" },
                                "isCompleteSentence": { "type": "BOOLEAN" },
                                "hasPunctuationErrors": { "type": "BOOLEAN" },
                                "summary": { "type": "STRING" }
                            },
                            "propertyOrdering": ["voice", "isCompleteSentence", "hasPunctuationErrors", "summary"]
                        },
                        "spellingAnalysis": {
                            "type": "ARRAY",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "misspelledWord": { "type": "STRING" },
                                    "suggestions": { "type": "ARRAY", "items": { "type": "STRING" } }
                                },
                                "propertyOrdering": ["misspelledWord", "suggestions"]
                            }
                        },
                        "structuralAnalysis": {
                            "type": "ARRAY",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "type": { "type": "STRING" },
                                    "text": { "type": "STRING" },
                                    "function": { "type": "STRING" }
                                },
                                "propertyOrdering": ["type", "text", "function"]
                            }
                        }
                    },
                    "propertyOrdering": ["posAnalysis", "grammarAnalysis", "spellingAnalysis", "structuralAnalysis"]
                }
            }
        };

        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message);
            }

            const result = await response.json();
            const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (jsonText) {
                const parsedJson = JSON.parse(jsonText);
                setAnalysis(parsedJson);
            } else {
                throw new Error("API response was empty or malformed.");
            }
        } catch (err) {
            console.error("Error analysing sentence:", err);
            setError(`Failed to analyse sentence: ${err.message}`);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-white text-gray-800 font-sans p-8 flex flex-col items-center">
            <style>
                {`
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
                    .font-sans {
                        font-family: 'Inter', sans-serif;
                    }
                    .tartan-button {
                        background-image: repeating-linear-gradient(45deg, rgba(0, 0, 0, 0.1) 0 1px, transparent 1px 11px),
                                          repeating-linear-gradient(135deg, rgba(0, 0, 0, 0.1) 0 1px, transparent 1px 11px),
                                          linear-gradient(to right, #004d40 0 10%, #00897b 10% 20%, #4db6ac 20% 40%, #00897b 40% 50%, #4db6ac 50% 70%, #00897b 70% 80%, #004d40 80% 100%);
                        background-size: 100% 100%;
                        color: white;
                        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
                        transition: all 0.3s ease;
                    }
                    .tartan-button:hover {
                        background-size: 105% 105%;
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                    }
                    .tartan-button:disabled {
                        background-image: repeating-linear-gradient(45deg, rgba(0, 0, 0, 0.2) 0 1px, transparent 1px 11px),
                                          repeating-linear-gradient(135deg, rgba(0, 0, 0, 0.2) 0 1px, transparent 1px 11px),
                                          linear-gradient(to right, #37474f 0 100%);
                        cursor: not-allowed;
                        box-shadow: none;
                    }
                `}
            </style>
            <div className="w-full max-w-2xl bg-gray-100 p-8 rounded-2xl shadow-xl space-y-6">
                <h1 className="text-4xl font-bold text-center text-teal-600">Sentence Analyser</h1>
                <p className="text-center text-gray-500">
                    Enter a sentence for analysis.
                </p>
                <div className="flex flex-col space-y-4">
                    <input
                        type="text"
                        value={sentence}
                        onChange={(e) => setSentence(e.target.value)}
                        className="w-full p-4 text-lg rounded-xl border border-gray-300 bg-gray-200 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-600"
                        placeholder="Enter a sentence for analysis..."
                    />
                    <button
                        onClick={handleAnalyse}
                        disabled={isLoading || !sentence.trim()}
                        className="w-full p-4 text-lg font-bold rounded-xl shadow-md tartan-button"
                    >
                        {isLoading ? (
                            <div className="flex justify-center items-center">
                                <svg className="animate-spin h-5 w-5 text-white mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Analysing...
                            </div>
                        ) : 'Analyse Sentence'}
                    </button>
                </div>
                {error && (
                    <div className="p-4 bg-red-200 text-red-800 rounded-xl">
                        {error}
                    </div>
                )}
                {analysis && (
                    <div className="mt-8 space-y-8">
                        {analysis.spellingAnalysis && analysis.spellingAnalysis.length > 0 && (
                            <div>
                                <h2 className="text-2xl font-bold text-teal-600 mb-4">Spelling Analysis:</h2>
                                <div className="bg-gray-200 p-6 rounded-xl space-y-4">
                                    {analysis.spellingAnalysis.map((error, index) => (
                                        <div key={index}>
                                            <p className="text-lg font-semibold text-red-600 mb-2">Misspelled word: <span className="font-bold">{error.misspelledWord}</span></p>
                                            <p className="text-md text-gray-700">Did you mean?</p>
                                            <ul className="list-disc list-inside ml-4 mt-1 space-y-1 text-gray-600">
                                                {error.suggestions.map((suggestion, sIndex) => (
                                                    <li key={sIndex}>{suggestion}</li>
                                                ))}
                                            </ul>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        <div>
                            <h2 className="text-2xl font-bold text-teal-600 mb-4">Parts of Speech:</h2>
                            <div className="flex flex-wrap gap-4 justify-center">
                                {analysis.posAnalysis.map((item, index) => (
                                    <div key={index} className="flex flex-col items-center p-4 bg-gray-200 rounded-xl shadow-md min-w-[120px]">
                                        <span className="text-xl font-bold text-gray-800 mb-1">{item.word}</span>
                                        <span className="text-sm font-semibold text-gray-600">{item.pos}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div>
                            <h2 className="text-2xl font-bold text-teal-600 mb-4">Grammatical Analysis:</h2>
                            <div className="bg-gray-200 p-6 rounded-xl space-y-4">
                                <div className="flex justify-between items-center text-lg">
                                    <span className="font-semibold">Voice:</span>
                                    <span className="text-gray-800">{analysis.grammarAnalysis.voice}</span>
                                </div>
                                <div className="flex justify-between items-center text-lg">
                                    <span className="font-semibold">Complete Sentence:</span>
                                    <span className={`font-bold ${analysis.grammarAnalysis.isCompleteSentence ? 'text-green-600' : 'text-red-600'}`}>
                                        {analysis.grammarAnalysis.isCompleteSentence ? 'Yes' : 'No'}
                                    </span>
                                </div>
                                <div className="flex justify-between items-center text-lg">
                                    <span className="font-semibold">Punctuation Errors:</span>
                                    <span className={`font-bold ${analysis.grammarAnalysis.hasPunctuationErrors ? 'text-red-600' : 'text-green-600'}`}>
                                        {analysis.grammarAnalysis.hasPunctuationErrors ? 'Yes' : 'No'}
                                    </span>
                                </div>
                                <div className="pt-4 border-t border-gray-300">
                                    <p className="font-semibold mb-2">Summary:</p>
                                    <p className="text-gray-700 text-md italic">{analysis.grammarAnalysis.summary}</p>
                                </div>
                            </div>
                        </div>
                        {analysis.structuralAnalysis && analysis.structuralAnalysis.length > 0 && (
                            <div>
                                <h2 className="text-2xl font-bold text-teal-600 mb-4">Structural Analysis:</h2>
                                <div className="bg-gray-200 p-6 rounded-xl space-y-4">
                                    {analysis.structuralAnalysis.map((structure, index) => (
                                        <div key={index} className="border-b border-gray-300 pb-4 last:border-b-0 last:pb-0">
                                            <p className="text-lg font-semibold text-gray-800 mb-1">{structure.type}: <span className="italic">{structure.text}</span></p>
                                            <p className="text-md text-gray-700">{structure.function}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </div>
        </div>
    );
};

export default App;
